<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flappy CID Bird Cinematic Loop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #ffffff;
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
  }
  canvas {
    display: block;
    margin: auto;
    background: #000;
    border: 2px solid #000;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== DEVICE DETECT =====
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// ===== MOBILE RESIZE =====
function resizeCanvas() {
  canvas.width = Math.min(window.innerWidth, 360);
  canvas.height = Math.min(window.innerHeight, 520);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// ===== IMAGES =====
const bgImg = new Image();
bgImg.src = "bg.jpg";

const birdImg = new Image();
birdImg.src = "bird.png";

// ===== SOUNDS =====
const startSound = new Audio("start.wav");
const gameOverSound = new Audio("gameover.wav");
const midSound = new Audio("mid1.wav");
midSound.loop = true;
let midPlaying = false;

// ===== BIRD (EASY PHYSICS) =====
const bird = {
  x: 60,
  y: 230,
  w: 42,
  h: 32,
  gravity: isMobile ? 0.25 : 0.20,   // ðŸ“± softer fall
  lift: isMobile ? -5.2 : -7.5,      // ðŸ“± less jump
  velocity: 0,
  angle: 0
};

// ===== GAME STATE =====
let pipes = [];
let frame = 0;
let score = 0;
let bestScore = localStorage.getItem("bestScore") || 0;
let gameOver = true;
let gameStarted = false;
let hitSlowMotion = false;
let shakeOffset = 0;

// ===== START GAME =====
function startGame() {
  pipes = [];
  score = 0;
  frame = 0;
  bird.y = 230;
  bird.velocity = 0;
  bird.angle = 0;
  gameOver = false;
  gameStarted = true;
  hitSlowMotion = false;
  shakeOffset = 0;

  gameOverSound.pause();
  gameOverSound.currentTime = 0;

  startSound.currentTime = 0;
  startSound.play();

  setTimeout(()=>{
    if(!gameOver){
      midSound.currentTime = 0;
      midSound.play();
      midPlaying = true;
    }
  },2500);
}

// ===== STOP MID SOUND =====
function stopMidSound(){
  if(midPlaying){
    midSound.pause();
    midSound.currentTime = 0;
    midPlaying = false;
  }
}

// ===== CONTROLS (ANTI-SPAM JUMP) =====
function flap(){
  if(!gameStarted || gameOver){
    startGame();
    return;
  }

  // ðŸ“± mobile friendly: already up à¦¥à¦¾à¦•à¦²à§‡ à¦†à¦° boost à¦¨à¦¾
  if(bird.velocity > -1.5){
    bird.velocity = bird.lift;
  }
}

document.addEventListener("keydown", flap);
canvas.addEventListener("click", flap);
canvas.addEventListener("touchstart", e=>{
  e.preventDefault();
  flap();
},{passive:false});

// ===== PIPE (EASY GAP & SPEED) =====
function addPipe(){
  const gap = isMobile ? 300 : 250; // ðŸ“± big gap
  const top = Math.random() * 120 + 90;
  pipes.push({
    x: canvas.width,
    top,
    bottom: top + gap,
    width: 50,
    passed: false
  });
}

// ===== GAME OVER =====
function triggerGameOver(){
  if(gameOver) return;
  gameOver = true;

  stopMidSound();
  gameOverSound.currentTime = 0;
  gameOverSound.play();

  hitSlowMotion = true;
  shakeOffset = 3; // ðŸ”¹ reduced shake

  if(score > bestScore){
    bestScore = score;
    localStorage.setItem("bestScore", bestScore);
  }
}

// ===== DRAW HELPERS =====
function drawBackground(){
  if(bgImg.complete) ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
  else { ctx.fillStyle="#111"; ctx.fillRect(0,0,canvas.width,canvas.height); }
}

function drawBird(){
  ctx.save();
  ctx.translate(bird.x+bird.w/2, bird.y+bird.h/2);
  ctx.rotate(bird.angle);
  ctx.drawImage(birdImg,-bird.w/2,-bird.h/2,bird.w,bird.h);
  ctx.restore();
}

function drawPipes(){
  ctx.fillStyle="#0f0";
  pipes.forEach(p=>{
    ctx.fillRect(p.x,0,p.width,p.top);
    ctx.fillRect(p.x,p.bottom,p.width,canvas.height);
  });
}

function drawScore(){
  ctx.fillStyle="#fff";
  ctx.font="20px Arial";
  ctx.textAlign="left";
  ctx.fillText("Score: "+score,10,25);
  ctx.fillText("Best: "+bestScore,10,50);
}

// ===== LOOP =====
function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  if(hitSlowMotion){
    ctx.translate((Math.random()-0.5)*shakeOffset,(Math.random()-0.5)*shakeOffset);
  }

  drawBackground();

  if(!gameStarted){
    ctx.fillStyle="#fff";
    ctx.font="24px Arial";
    ctx.fillText("Tap to Start",115,260);
    drawBird();
    ctx.restore();
    requestAnimationFrame(update);
    return;
  }

  if(!gameOver){
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;

    bird.angle = bird.velocity < 0 ? -0.25 : Math.min(bird.velocity*0.025,0.4);

    if(frame % (isMobile ? 180 : 150) === 0) addPipe();

    pipes.forEach(p=>{
      p.x -= isMobile ? 0.9 : 1.0; // ðŸ“± slower pipes
      if(!p.passed && p.x+p.width<bird.x){ score++; p.passed=true; }
      if(bird.x < p.x+p.width && bird.x+bird.w>p.x && (bird.y<p.top || bird.y+bird.h>p.bottom)){
        triggerGameOver();
      }
    });

    pipes = pipes.filter(p=>p.x+p.width>0);
    if(bird.y<0 || bird.y+bird.h>canvas.height) triggerGameOver();
  } else {
    ctx.fillStyle="rgba(0,0,0,0.6)";
    ctx.fillRect(50,200,canvas.width-100,100);

    ctx.fillStyle="red";
    ctx.font="30px Arial";
    ctx.textAlign="center";
    ctx.fillText("Game Over",canvas.width/2,240);

    ctx.fillStyle="#fff";
    ctx.font="16px Arial";
    ctx.fillText("Tap to Restart",canvas.width/2,270);
  }

  drawBird();
  drawPipes();
  drawScore();

  ctx.restore();
  frame++;
  requestAnimationFrame(update);
}

update();
</script>

</body>
</html>
